<script>
    let pieces = JSON.parse(localStorage.getItem('piecesV4') || '[]');
    let records = JSON.parse(localStorage.getItem('recordsV4') || '[]');
    let sessionTime = JSON.parse(localStorage.getItem('sessionTimeV4') || '{}');
    let sessionTimer = null;
    let sessionStart = null;
    const todayStr = new Date().toISOString().split('T')[0];
    document.getElementById('today').textContent = new Date().toLocaleDateString('ko-KR', {
      year: 'numeric', month: 'long', day: 'numeric', weekday: 'long'
    });

    function saveAll() {
      localStorage.setItem('piecesV4', JSON.stringify(pieces));
      localStorage.setItem('recordsV4', JSON.stringify(records));
      localStorage.setItem('sessionTimeV4', JSON.stringify(sessionTime));
    }

    function formatTime(mins) {
      const min = Math.floor(mins);
      const sec = Math.round((mins - min) * 60);
      return `${min}분 ${sec}초`;
    }

    function toggleSessionTimer() {
      const btn = document.getElementById('sessionBtn');
      if (!sessionTimer) {
        sessionStart = Date.now();
        sessionTimer = setInterval(() => {
          const now = Date.now();
          const totalSec = Math.floor((now - sessionStart) / 1000);
          const totalMins = (sessionTime[todayStr] || 0) + totalSec / 60;
          document.getElementById('sessionTime').textContent = formatTime(totalMins);
        }, 1000);
        btn.textContent = '종료';
      } else {
        clearInterval(sessionTimer);
        const now = Date.now();
        const diffSec = Math.floor((now - sessionStart) / 1000);
        sessionTime[todayStr] = (sessionTime[todayStr] || 0) + diffSec / 60;
        sessionTimer = null;
        sessionStart = null;
        btn.textContent = '시작';
        document.getElementById('sessionTime').textContent = formatTime(sessionTime[todayStr]);
        saveAll();
        openEditModal();
      }
    }

    renderPieces();
    document.getElementById('sessionTime').textContent = formatTime(sessionTime[todayStr] || 0);
</script>
