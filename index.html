<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#ffffff">
  <link rel="manifest" href="manifest.json">
  <title>디피갤 피출</title>
  <style>
    body { margin: 0; font-family: 'Noto Sans KR', sans-serif; background: #fff; color: #222; }
    header { background: #f3f4f6; padding: 1rem; text-align: center; font-size: 1.5rem; font-weight: bold; }
    .date { font-size: 1rem; color: #666; margin-top: 0.25rem; }
    main { padding: 1rem; }
    .button { background: #4f46e5; color: #fff; border: none; border-radius: 6px; padding: 0.5rem 1rem; font-size: 1rem; cursor: pointer; }
    .tab { display: flex; gap: 1rem; margin: 1rem 0; }
    .tab button { flex: 1; background: #e0e7ff; border: none; padding: 0.5rem; border-radius: 6px; font-weight: bold; }
    .tab button.active { background: #4f46e5; color: white; }
    .card-row { display: flex; justify-content: space-between; align-items: center; background: #f8fafc; border-radius: 12px; padding: 0.75rem 1rem; margin: 0.5rem 0; cursor: pointer; }
    .card-left { display: flex; align-items: center; gap: 0.5rem; }
    .emoji { font-size: 1.2rem; }
    .piece-title { font-weight: bold; font-size: 1rem; }
    .stats { font-size: 1rem; color: #333; }
    .details { padding: 1rem; border-left: 4px solid #4f46e5; margin: 0.5rem 0 1rem 0; background: #f1f5ff; border-radius: 0 0 8px 8px; }
    .details textarea, .details input { width: 100%; margin-top: 0.5rem; padding: 0.5rem; font-size: 1rem; border-radius: 6px; border: 1px solid #ccc; }
    .stats-table { margin-top: 1rem; border-top: 1px solid #ddd; padding-top: 1rem; }
    .stats-row { display: flex; justify-content: space-between; padding: 0.5rem 0; border-bottom: 1px dashed #eee; }
    .utility { margin: 1rem 0; display: flex; gap: 0.5rem; flex-wrap: wrap; }
    .input-group { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
    input[type='text'] { flex: 1; padding: 0.5rem; font-size: 1rem; border: 1px solid #ccc; border-radius: 6px; }
    .session-timer { margin: 1rem 0; text-align: center; font-size: 1.2rem; color: #4f46e5; }
    .time-select { margin: 0.5rem auto; text-align: center; }
    .time-select input { padding: 0.5rem; font-size: 1rem; }
  </style>
</head>
<body>
  <header>
    디피갤 피출
    <div class="date" id="today"></div>
  </header>
  <main>
    <div class="tab">
      <button class="active" onclick="showView('log')">기록</button>
      <button onclick="showView('stats')">통계</button>
    </div>
    <div class="utility">
      <button class="button" onclick="exportCSV()">⬇️ 내보내기</button>
      <label class="button">
        ⬆️ 불러오기 <input type="file" accept=".csv" onchange="importCSV(event)" style="display:none">
      </label>
      <button class="button" onclick="resetAll()">🧼 초기화</button>
    </div>
    <div id="logView">
      <div class="session-timer">
        ⏱ 오늘 총 연습 시간: <span id="sessionTime">0분 0초</span>
        <div class="time-select">
          시작 시각: <input type="time" id="startPicker"> 종료 시각: <input type="time" id="endPicker" style="display:none">
        </div>
        <button class="button" onclick="toggleSessionTimer()" id="sessionBtn">시작</button>
      </div>
      <div class="input-group">
        <input type="text" id="newPiece" placeholder="새 곡 입력 (예: Hanon 39)" />
        <button class="button" onclick="addPiece()">추가</button>
      </div>
      <div id="pieceList"></div>
    </div>
    <div id="statsView" style="display:none">
      <div class="stats-table" id="statsTable"></div>
    </div>
  </main>

  <script>
    let pieces = JSON.parse(localStorage.getItem('piecesV4') || '[]');
    let records = JSON.parse(localStorage.getItem('recordsV4') || '[]');
    let sessionTime = JSON.parse(localStorage.getItem('sessionTimeV4') || '{}');
    let sessionTimer = null;
    let sessionStart = null;
    const todayStr = new Date().toISOString().split('T')[0];

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('today').textContent = new Date().toLocaleDateString('ko-KR', {
        year: 'numeric', month: 'long', day: 'numeric', weekday: 'long'
      });
      renderPieces();
      document.getElementById('sessionTime').textContent = formatTime(sessionTime[todayStr] || 0);
    });

    function formatTime(mins) {
      const min = Math.floor(mins);
      const sec = Math.round((mins - min) * 60);
      return `${min}분 ${sec}초`;
    }

    function saveAll() {
      localStorage.setItem('piecesV4', JSON.stringify(pieces));
      localStorage.setItem('recordsV4', JSON.stringify(records));
      localStorage.setItem('sessionTimeV4', JSON.stringify(sessionTime));
    }

    function toggleSessionTimer() {
      const btn = document.getElementById('sessionBtn');
      const startInput = document.getElementById('startPicker');
      const endInput = document.getElementById('endPicker');
      if (!sessionTimer) {
        let selected = startInput?.value;
        if (selected) {
          const today = new Date();
          const [h, m] = selected.split(":");
          today.setHours(parseInt(h));
          today.setMinutes(parseInt(m));
          today.setSeconds(0);
          sessionStart = today.getTime();
        } else {
          sessionStart = Date.now();
        }
        sessionTimer = setInterval(() => {
          const now = Date.now();
          const totalSec = Math.floor((now - sessionStart) / 1000);
          const totalMins = (sessionTime[todayStr] || 0) + totalSec / 60;
          document.getElementById('sessionTime').textContent = formatTime(totalMins);
        }, 1000);
        btn.textContent = '종료';
        if (endInput) endInput.style.display = 'inline-block';
      } else {
        let endTime = Date.now();
        if (endInput?.value) {
          const today = new Date();
          const [h, m] = endInput.value.split(":");
          today.setHours(parseInt(h));
          today.setMinutes(parseInt(m));
          today.setSeconds(0);
          endTime = today.getTime();
        }
        clearInterval(sessionTimer);
        const diffSec = Math.floor((endTime - sessionStart) / 1000);
        if (diffSec > 0) {
          sessionTime[todayStr] = (sessionTime[todayStr] || 0) + diffSec / 60;
        }
        sessionTimer = null;
        sessionStart = null;
        btn.textContent = '시작';
        if (endInput) endInput.style.display = 'none';
        document.getElementById('sessionTime').textContent = formatTime(sessionTime[todayStr]);
        saveAll();
      }
    }

    function addPiece() {
      const input = document.getElementById('newPiece');
      const name = input.value.trim();
      if (!name) return;
      pieces.push({ name, emoji: '🎹', active: true });
      input.value = '';
      saveAll();
      renderPieces();
    }

    function renderPieces() {
      const box = document.getElementById('pieceList');
      box.innerHTML = '';
      pieces.forEach((p, idx) => {
        if (!p.active) return;
        const row = document.createElement('div');
        row.className = 'card-row';
        row.innerHTML = `
          <div class="card-left">
            <input type="checkbox" onchange="toggleCheck(${idx})" />
            <span class="emoji">${p.emoji}</span>
            <span class="piece-title">${p.name}</span>
          </div>
          <div class="stats">0회</div>
        `;
        box.appendChild(row);
      });
    }

    function toggleCheck(idx) {
      // 체크박스 로직 필요시 여기에 추가
    }
  </script>
</body>
</html>
