<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#ffffff">
  <link rel="manifest" href="manifest.json">
  <title>디피갤 피출</title>
  <style>
    body { font-family: 'Noto Sans KR', sans-serif; background: #fff; color: #222; margin: 0; padding: 1rem; }
    header { text-align: center; margin-bottom: 1rem; }
    h1 { margin: 0.5rem 0; }
    .date { font-size: 0.9rem; color: #666; }
    .button { background: #4f46e5; color: #fff; border: none; border-radius: 6px; padding: 0.5rem 1rem; font-size: 1rem; cursor: pointer; margin: 0.25rem; }
    .input-group { display: flex; gap: 0.5rem; margin-bottom: 1rem; }
    input[type='text'] { flex: 1; padding: 0.5rem; font-size: 1rem; border: 1px solid #ccc; border-radius: 6px; }
    .card { border: 1px solid #ccc; padding: 1rem; margin-bottom: 1rem; border-radius: 0.5rem; }
    .card h3 { margin: 0; cursor: pointer; font-size: 1.1rem; }
    .history { margin-top: 0.5rem; padding-left: 1rem; font-size: 0.9rem; color: #555; display: none; }
    .checkbox-wrap { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; flex-wrap: wrap; }
    .utility { display: flex; gap: 0.5rem; flex-wrap: wrap; margin-bottom: 1rem; }
    .session-timer { text-align: center; margin: 1rem 0; font-size: 1.1rem; }
  </style>
</head>
<body>
  <header>
    <h1>디피갤 피출</h1>
    <div class="date" id="today"></div>
  </header>

  <div class="utility">
    <button class="button" onclick="exportCSV()">⬇️ 내보내기</button>
    <label class="button">⬆️ 불러오기<input type="file" accept=".csv" onchange="importCSV(event)" style="display:none"></label>
    <button class="button" onclick="resetAll()">🧼 초기화</button>
  </div>

  <div class="session-timer">
    ⏱ 오늘 총 연습 시간: <span id="sessionTime">0분 0초</span>
    <button class="button" onclick="toggleSessionTimer()" id="sessionBtn">시작</button>
  </div>

  <div class="input-group">
    <input type="text" id="newPiece" placeholder="새 곡 입력 (예: Hanon 39)">
    <button class="button" onclick="addPiece()">추가</button>
  </div>

  <button class="button" onclick="renderByDate()">📅 날짜별 연습 보기</button>
  <div id="calendarList"></div>
  <div id="pieceList"></div>

  <script>
    const records = JSON.parse(localStorage.getItem('recordsV4') || '[]');
    let pieces = JSON.parse(localStorage.getItem('piecesV4') || '[]');
    let sessionTime = JSON.parse(localStorage.getItem('sessionTimeV4') || '{}');
    let sessionTimer = null;
    let sessionStart = null;
    const todayStr = new Date().toISOString().split('T')[0];

    document.getElementById('today').textContent = new Date().toLocaleDateString('ko-KR', {
      year: 'numeric', month: 'long', day: 'numeric', weekday: 'long'
    });

    function saveAll() {
      localStorage.setItem('piecesV4', JSON.stringify(pieces));
      localStorage.setItem('recordsV4', JSON.stringify(records));
      localStorage.setItem('sessionTimeV4', JSON.stringify(sessionTime));
    }

    function toggleSessionTimer() {
      const btn = document.getElementById('sessionBtn');
      if (!sessionTimer) {
        sessionStart = Date.now();
        sessionTimer = setInterval(() => {
          const now = Date.now();
          const totalSec = Math.floor((now - sessionStart) / 1000);
          const totalMins = (sessionTime[todayStr] || 0) + totalSec / 60;
          document.getElementById('sessionTime').textContent = formatTime(totalMins);
        }, 1000);
        btn.textContent = '종료';
      } else {
        clearInterval(sessionTimer);
        const now = Date.now();
        const diffSec = Math.floor((now - sessionStart) / 1000);
        sessionTime[todayStr] = (sessionTime[todayStr] || 0) + diffSec / 60;
        sessionTimer = null;
        sessionStart = null;
        btn.textContent = '시작';
        document.getElementById('sessionTime').textContent = formatTime(sessionTime[todayStr]);
        saveAll();
      }
    }

    function formatTime(mins) {
      const min = Math.floor(mins);
      const sec = Math.round((mins - min) * 60);
      return `${min}분 ${sec}초`;
    }

    function exportCSV() {
      const all = JSON.stringify({ pieces, records });
      const blob = new Blob([all], { type: 'application/json' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'practice-log.json';
      a.click();
    }

    function importCSV(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const parsed = JSON.parse(reader.result);
          if (parsed.pieces && parsed.records) {
            pieces = parsed.pieces;
            records = parsed.records;
            saveAll();
            renderPieces();

    function renderByDate() {
      const box = document.getElementById('calendarList');
      box.innerHTML = '<h3>📆 날짜별 연습 기록</h3>';
      const grouped = {};
      records.forEach(r => {
        if (!grouped[r.date]) grouped[r.date] = [];
        grouped[r.date].push(r);
      });
      const dates = Object.keys(grouped).sort().reverse();
      dates.forEach(date => {
        const section = document.createElement('div');
        section.style.marginTop = '0.75rem';
        section.innerHTML = `<strong>${date}</strong><br>` +
          grouped[date].map(r => `🎹 ${r.name} - ${r.count}회`).join('<br>');
        box.appendChild(section);
      });
    }
          }
        } catch (err) {
          alert('불러오기 실패');
        }
      };
      reader.readAsText(file);
    }

    function resetAll() {
      if (confirm('모든 데이터를 초기화할까요?')) {
        pieces = [];
        records.length = 0;
        sessionTime = {};
        saveAll();
        renderPieces();
        document.getElementById('sessionTime').textContent = '0분 0초';
      }
    }

    function addPiece() {
      const input = document.getElementById('newPiece');
      const name = input.value.trim();
      if (!name) return;
      if (!pieces.find(p => p.name === name)) {
        pieces.push({ name, enabled: true });
        saveAll();
        renderPieces();
      }
      input.value = '';
    }

    function toggleEnabled(index) {
      pieces[index].enabled = !pieces[index].enabled;
      saveAll();
      renderPieces();
    }

    function addCount(name) {
      let rec = records.find(r => r.name === name && r.date === todayStr);
      if (!rec) {
        rec = { name, date: todayStr, count: 1 };
        records.push(rec);
      } else {
        rec.count++;
      }
      saveAll();
      renderPieces();
    }

    function renderPieces() {
      const container = document.getElementById('pieceList');
      container.innerHTML = '';
      pieces.forEach((p, idx) => {
        if (!p.enabled) return;
        const card = document.createElement('div');
        card.className = 'card';

        const topRow = document.createElement('div');
        topRow.className = 'checkbox-wrap';

        const checkbox = document.createElement('input');
        checkbox.type = 'checkbox';
        checkbox.checked = true;
        checkbox.onchange = () => toggleEnabled(idx);

        const label = document.createElement('label');
        label.textContent = p.name;
        label.style.fontWeight = 'bold';
        label.onclick = () => {
          historyBox.style.display = historyBox.style.display === 'none' ? 'block' : 'none';
        };

        const addBtn = document.createElement('button');
        addBtn.textContent = '+1회';
        addBtn.className = 'button';
        addBtn.style.padding = '0.25rem 0.5rem';
        addBtn.style.fontSize = '0.8rem';
        addBtn.onclick = () => addCount(p.name);

        const todayLog = records.find(r => r.name === p.name && r.date === todayStr);
        const countText = document.createElement('span');
        countText.textContent = `오늘 ${todayLog?.count || 0}회`;
        countText.style.marginLeft = '0.5rem';

        topRow.appendChild(checkbox);
        topRow.appendChild(label);
        topRow.appendChild(addBtn);
        topRow.appendChild(countText);

        const historyBox = document.createElement('div');
        historyBox.className = 'history';
        const logs = records.filter(r => r.name === p.name).sort((a, b) => b.date.localeCompare(a.date));
        historyBox.innerHTML = logs.map(log => `<div>${log.date}: ${log.count}회</div>`).join('') || '<div>기록 없음</div>';

        card.appendChild(topRow);
        card.appendChild(historyBox);
        container.appendChild(card);
      });
    }

    renderPieces();
    document.getElementById('sessionTime').textContent = formatTime(sessionTime[todayStr] || 0);
  </script>
</body>
</html>
